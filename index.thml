<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI 测试版</title>
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f0f2f5; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; }
        .msg { margin-bottom: 15px; padding: 10px 15px; border-radius: 10px; max-width: 80%; word-break: break-all; }
        .user { background: #007bff; color: white; align-self: flex-end; margin-left: auto; }
        .ai { background: white; color: #333; border: 1px solid #ddd; }
        .error { background: #ffeef0; color: #d73a49; border: 1px solid #ffcfd3; align-self: center; width: 90%; }
        #input-container { display: flex; padding: 20px; background: white; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        button { padding: 10px 20px; margin-left: 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

<div id="chat-box" style="display: flex; flex-direction: column;">
    <div class="msg ai">系统提示：请确保 URL 包含 ?key=... <br>当前状态：等待输入...</div>
</div>

<div id="input-container">
    <input type="text" id="user-input" placeholder="输入对话内容...">
    <button id="send-btn">发送</button>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    // 获取 URL 中的 Key
    const params = new URLSearchParams(window.location.search);
    const apiKey = params.get('key');

    function addMessage(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function callGemini() {
        const prompt = userInput.value.trim();
        if (!prompt) return;
        if (!apiKey) {
            addMessage('error', '错误：找不到 API Key！请在地址栏最后加上 ?key=你的密钥');
            return;
        }

        addMessage('user', prompt);
        userInput.value = '';
        sendBtn.disabled = true;
        sendBtn.innerText = '思考中...';

        try {
            // 使用 Gemini 1.5 Flash 模型 (目前响应最快且免费额度高)
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            const data = await response.json();

            if (data.error) {
                addMessage('error', 'API 报错: ' + data.error.message);
            } else if (data.candidates && data.candidates[0].content) {
                const aiText = data.candidates[0].content.parts[0].text;
                addMessage('ai', aiText);
            } else {
                addMessage('error', '收到空回复，可能是触发了安全过滤或 API 限制。');
            }
        } catch (err) {
            addMessage('error', '网络连接失败：请检查是否开启了代理(VPN)或者 API 地址是否被拦截。');
            console.error(err);
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerText = '发送';
        }
    }

    sendBtn.addEventListener('click', callGemini);
    userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') callGemini(); });
</script>

</body>
</html>
